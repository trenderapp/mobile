import React, { useEffect, useState } from "react";
import { useTranslation } from "react-i18next";
import { useNavigation } from "@react-navigation/native";
import { View } from 'react-native';
import SearchBar from 'react-native-dynamic-search-bar';
import { Appbar } from "react-native-paper";
import { full_width } from "../../Style/style";
import { useClient, useTheme } from "../Container";
import MemberList from "../Profile/MemberList";

function SearchModal({ route }) {

    const { colors } = useTheme();
    const params = route.params;
    const { searchParams, displayText } = params.params;
    const { t } = useTranslation();
    const { client } = useClient();
    const [users, setInfo] = useState([]);
    const [loader, setLoader] = useState(true);
    const navigation = useNavigation();
    const [text, setText] = useState("");
    const [filter, setFilter] = useState(null)

    /**
     * 
     * @param {String} query 
     * @returns {Object}
     */
    function parseSearchQuery(query) {
        setText(query)
        const keywords = ["after", "before", "locale", "from", "type"];
        let result = {};
      
        keywords.forEach((keyword) => {
          const regex = new RegExp(`${keyword}:\\s*(.+?)(?:\\s+\\w+:|$)`, "i");
          const match = query.match(regex);
          if (match) {
            result[keyword] = match[1].trim();
            query = query.replace(regex, '').trim();
          }
        });
      
        result['query'] = query;
        return setFilter(result);
    }

    useEffect(() => {
        async function getData() {
            setLoader(true)
            const request = await client.user.search(searchParams?.query);
            setLoader(false)
            if (!request) return setInfo([])
            if (request.error) return;

            setInfo(request.data);
        }

        if (searchParams?.query?.length > 0) getData();
    }, [text])

    return (
        <View style={{ flex: 1, backgroundColor: colors.bg_primary }}>
            <Appbar.Header style={{ width: full_width, backgroundColor: colors.bg_primary, flexDirection: "row" }}>
                <Appbar.BackAction onPress={() => navigation.goBack()} />
                <SearchBar
                    searchIconImageStyle={{
                        tintColor: colors.text_normal
                    }}
                    clearIconImageStyle={{
                        tintColor: colors.text_normal
                    }}
                    placeholderTextColor={colors.text_normal}
                    style={{
                        backgroundColor: colors.bg_secondary,
                        width: 330
                    }}
                    textInputStyle={{
                        color: colors.text_normal
                    }}
                    value={displayText}
                    onClearPress={() => {
                        setFilter(null)
                        return setText(null)
                    }}
                    onChangeText={(t) => parseSearchQuery(t)}
                />
            </Appbar.Header>
            {users.length > 0 && <MemberList list={users} loader={loader} />}
        </View>
    )
}

export default SearchModal;